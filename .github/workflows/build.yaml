name: Build Toolchain

on:
  pull_request:
    types: [synchronize, opened, reopened, ready_for_review]
    branches: [ "main" ]
  workflow_dispatch:    # Trigger on manual run
  release:              # Trigger on release
    types:
      - published

jobs:
  build:
    strategy:
      matrix:
        os:  [ci-prod-AWS-CPU-X86_64-EKS, ci-prod-AWS-CPU-ARM64-NATIVE]
        label: [ubuntu, centos7]
        exclude:
          - os: ci-prod-AWS-CPU-ARM64-NATIVE
          - label: centos7
        include:
          - os: ci-prod-AWS-CPU-X86_64-EKS
            container: false
            label: ubuntu
            arch: amd64
          - os: ci-prod-AWS-CPU-X86_64-EKS
            container: ghcr.io/axelera-ai/centos7-toolchain:v0.2
            label: centos7
            arch: amd64
          - os: [macOS, self-hosted]
            container: false
            label: macos
            arch: arm64
          - os: ci-prod-AWS-CPU-ARM64-NATIVE
            container: false
            label: ubuntu
            arch: arm64

    runs-on: ${{ matrix.os }}

    name: Build and package (${{ matrix.label }}, ${{ matrix.arch }})

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      if: ${{ !contains(matrix.os, 'macOS') }}
      run: |
        (type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)) \
          && sudo mkdir -p -m 755 /etc/apt/keyrings \
          && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
          && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt-key adv --fetch-keys https://apt.kitware.com/keys/kitware-archive-latest.asc
        DISTRO_CODENAME=$(lsb_release -cs)
        sudo apt-add-repository "deb https://apt.kitware.com/ubuntu/ $DISTRO_CODENAME main"
        sudo apt-get update && \
        sudo apt-get install -y \
        autoconf \
        automake \
        autotools-dev \
        curl \
        python3 \
        python-is-python3 \
        python3-pip \
        libmpc-dev \
        libmpfr-dev \
        libgmp-dev \
        gawk \
        build-essential \
        bison \
        flex \
        texinfo \
        gperf \
        libtool \
        patchutils \
        bc \
        zlib1g-dev \
        libexpat-dev \
        ninja-build \
        git \
        libglib2.0-dev \
        libslirp-dev \
        fakeroot \
        gh \
        cmake

    - name: Log in to GHCR
      if: matrix.container != false
      uses: docker/login-action@v3.3.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Pull container image
      if: matrix.container != false
      run: docker pull ${{ matrix.container }}

    - name: Execute keyscan for repo servers
      run: |
        [[ -e ~/.ssh/known_hosts ]] && ssh-keygen -R github.com || true
        mkdir -p ~/.ssh
        ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      shell: bash

    - uses: webfactory/ssh-agent@v0.9.0
      with:
          ssh-private-key: ${{ secrets.TOOLS_LLVM_DEPLOY_KEY }}

    - name: Build Toolchain (container)
      if:  matrix.container != false
      run: |
          source ./versions.sh
          git clone --depth 1 --single-branch --branch $LLVM_BRANCH git@github.com:axelera-ai/tools.llvm-project.git llvm-project
          docker run --rm -v ${{ github.workspace }}:/workspace \
            -v /etc/passwd:/etc/passwd:ro \
            -v /etc/group:/etc/group:ro  \
            -w /workspace -u $(id -u):$(id -g) \
            ${{ matrix.container }} bash -c "./build_toolchain.sh"

    - name: Build Toolchain (native)
      if: matrix.container == false
      run: ./build_toolchain.sh

    - name: Archive the build directory
      run: |
        tar -czf riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.tar.gz riscv64-unknown-elf-toolchain-axelera

    # Create `deb` file
    - name: Create DEBIAN directory
      if: contains(matrix.label, 'ubuntu')
      run: |
        mkdir -p riscv64-unknown-elf-toolchain-axelera/DEBIAN
        find riscv64-unknown-elf-toolchain-axelera -type d | xargs chmod 755

    - name: Create control file with version
      if: contains(matrix.label, 'ubuntu')
      run: |
          source versions.sh
          DEB_PKG_ARCH="${{ matrix.arch }}"
          PKG_VERSION=$(echo ${{ github.sha }} | cut -c1-12)

          # Use sed to replace the placeholders with actual values
          sed -e "s/@PKG_VERSION@/${PKG_VERSION}/" \
              -e "s/@PKG_RELEASE_NUMBER@/${PKG_RELEASE_NUMBER}/" \
              -e "s/@DEB_PKG_ARCH@/${DEB_PKG_ARCH}/" \
              -e "s/@PKG_DEPENDS@/${PKG_DEPENDS}/" \
              debian-pkg-control.in > riscv64-unknown-elf-toolchain-axelera/DEBIAN/control

    - name: Build DEB package
      if: contains(matrix.label, 'ubuntu')
      run: |
        fakeroot dpkg-deb --build riscv64-unknown-elf-toolchain-axelera
        mv riscv64-unknown-elf-toolchain-axelera.deb riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.deb

    # Upload the build artifacts
    - name: Upload build artifact
      if: contains(matrix.label, 'ubuntu')
      uses: actions/upload-artifact@v4
      with:
        name: riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.deb
        path: riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.deb

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.tar.gz
        path: riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.tar.gz

    - name: Upload to Release
      if: github.event_name == 'release'
      run: |
        gh release upload ${{ github.event.release.tag_name }} \
        riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.tar.gz
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to Release
      if: github.event_name == 'release' && contains(matrix.label, 'ubuntu')
      run: |
        gh release upload ${{ github.event.release.tag_name }} \
        riscv64-unknown-elf-toolchain-axelera-${{ matrix.arch }}-${{ matrix.label }}.deb
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
